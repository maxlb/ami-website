var listePays = {
    "Afrique du Sud": null,
    "Algérie": null,
    "Angola": null,
    "Bénin": null,
    "Botswana": null,
    "Burkina": null,
    "Burundi": null,
    "Cameroun": null,
    "Cap-Vert": null,
    "République centrafricaine": null,
    "Comores": null,
    "Congo": null,
    "République démocratique du Congo": null,
    "Côte d'Ivoire": null,
    "Djibouti": null,
    "Égypte": null,
    "Érythrée": null,
    "Éthiopie": null,
    "Gabon": null,
    "Gambie": null,
    "Ghana": null,
    "Guinée": null,
    "Guinée-Bissau": null,
    "Guinée équatoriale": null,
    "Kenya": null,
    "Lesotho": null,
    "Libéria": null,
    "Libye": null,
    "Madagascar": null,
    "Malawi": null,
    "Mali": null,
    "Maroc": null,
    "Maurice": null,
    "Mauritanie": null,
    "Mozambique": null,
    "Namibie": null,
    "Niger": null,
    "Nigeria": null,
    "Ouganda": null,
    "Rwanda": null,
    "Sao Tomé-et-Principe": null,
    "Sénégal": null,
    "Seychelles": null,
    "Sierra Leone": null,
    "Somalie": null,
    "Soudan": null,
    "Sud-Soudan": null,
    "Swaziland": null,
    "Tanzanie": null,
    "Tchad": null,
    "Togo": null,
    "Tunisie": null,
    "Zambie": null,
    "Zimbabwe": null,
    "Antigua-et-Barbuda": null,
    "Argentine": null,
    "Bahamas": null,
    "Barbade": null,
    "Belize": null,
    "Bolivie": null,
    "Brésil": null,
    "Canada": null,
    "Chili": null,
    "Colombie": null,
    "Costa Rica": null,
    "Cuba": null,
    "République dominicaine": null,
    "Dominique": null,
    "Équateur": null,
    "États-Unis": null,
    "Grenade": null,
    "Guatemala": null,
    "Guyana": null,
    "Haïti": null,
    "Honduras": null,
    "Jamaïque": null,
    "Mexique": null,
    "Nicaragua": null,
    "Panama": null,
    "Paraguay": null,
    "Pérou": null,
    "Porto Rico": null,
    "Saint-Christophe-et-Niévès": null,
    "Sainte-Lucie": null,
    "Saint-Vincent-et-les Grenadines": null,
    "Salvador": null,
    "Suriname": null,
    "Trinité-et-Tobago": null,
    "Uruguay": null,
    "Venezuela": null,
    "Afghanistan": null,
    "Arabie saoudite": null,
    "Bahreïn": null,
    "Bangladesh": null,
    "Bhoutan": null,
    "Birmanie": null,
    "Brunei": null,
    "Cambodge": null,
    "Chine": null,
    "Corée du Nord": null,
    "Corée du Sud": null,
    "Émirats arabes unis": null,
    "Inde": null,
    "Indonésie": null,
    "Irak": null,
    "Iran": null,
    "Israël": null,
    "Japon": null,
    "Jordanie": null,
    "Kazakhstan": null,
    "Kirghizistan": null,
    "Koweït": null,
    "Laos": null,
    "Liban": null,
    "Malaisie": null,
    "Maldives": null,
    "Mongolie": null,
    "Népal": null,
    "Oman": null,
    "Ouzbékistan": null,
    "Palestine": null,
    "Pakistan": null,
    "Philippines": null,
    "Qatar": null,
    "Singapour": null,
    "Sri Lanka": null,
    "Syrie": null,
    "Tadjikistan": null,
    "Taïwan": null,
    "Thaïlande": null,
    "Timor oriental": null,
    "Turkménistan": null,
    "Turquie": null,
    "Viêt Nam": null,
    "Yémen": null,
    "Allemagne": null,
    "Albanie": null,
    "Andorre": null,
    "Arménie": null,
    "Autriche": null,
    "Azerbaïdjan": null,
    "Belgique": null,
    "Biélorussie": null,
    "Bosnie-Herzégovine": null,
    "Bulgarie": null,
    "Chypre": null,
    "Croatie": null,
    "Danemark": null,
    "Espagne": null,
    "Estonie": null,
    "Finlande": null,
    "France": null,
    "Géorgie": null,
    "Grèce": null,
    "Hongrie": null,
    "Irlande": null,
    "Islande": null,
    "Italie": null,
    "Lettonie": null,
    "Liechtenstein": null,
    "Lituanie": null,
    "Luxembourg": null,
    "République de Macédoine": null,
    "Malte": null,
    "Moldavie": null,
    "Monaco": null,
    "Monténégro": null,
    "Norvège": null,
    "Pays-Bas": null,
    "Pologne": null,
    "Portugal": null,
    "République tchèque": null,
    "Roumanie": null,
    "Royaume-Uni": null,
    "Russie": null,
    "Saint-Marin": null,
    "Serbie": null,
    "Slovaquie": null,
    "Slovénie": null,
    "Suède": null,
    "Suisse": null,
    "Ukraine": null,
    "Vatican": null,
    "Australie": null,
    "Fidji": null,
    "Kiribati": null,
    "Marshall": null,
    "Micronésie": null,
    "Nauru": null,
    "Nouvelle-Zélande": null,
    "Palaos": null,
    "Papouasie-Nouvelle-Guinée": null,
    "Salomon": null,
    "Samoa": null,
    "Tonga": null,
    "Tuvalu": null,
    "Vanuatu": null
}

var listeNationalites = {
"Afghane": null,
"Sud-Africaine": null,
"Albanaise": null,
"Algérienne": null,
"Allemande": null,
"Andorrane": null,
"Angolaise": null,
"Antiguaise et Barbudienne": null,
"Saoudienne": null,
"Argentine": null,
"Arménienne": null,
"Australienne": null,
"Autrichienne": null,
"Azerbaïdjanaise": null,
"Bahreïnienne": null,
"Bangladaise": null,
"Barbadienne": null,
"Belge": null,
"Bélizienne": null,
"Béninoise": null,
"Bhoutanaise": null,
"Biélorusse": null,
"Birmane": null,
"Bolivienne": null,
"Bosniaque": null,
"Botswanéenne": null,
"Brésilienne": null,
"Brunéienne": null,
"Bulgare": null,
"Burkinabè": null,
"Burundais": null,
"Cambodgiennes": null,
"Camerounaise": null,
"Canadienne": null,
"Cap-Verdienne": null,
"Centrafricaine": null,
"Chilienne": null,
"Chinoise": null,
"Chypriote": null,
"Colombienne": null,
"Comorienne": null,
"Congolaise": null,
"Sud-Coréenne": null,
"Nord-Coréenne": null,
"Costaricaine": null,
"Ivoirienne": null,
"Croate": null,
"Cubaine": null,
"Danoise": null,
"Djiboutienne": null,
"Dominicaine": null,
"Dominiquaise": null,
"Egyptienne": null,
"Emirienne": null,
"Equatorienne": null,
"Erythréenne": null,
"Espagnole": null,
"Estonienne": null,
"Américaine": null,
"Éthiopienne": null,
"Fidjienne": null,
"Finlandaise": null,
"Française": null,
"Gabonaise": null,
"Gambienne": null,
"Géorgienne": null,
"Ghanéenne": null,
"Grecque": null,
"Grenadienne": null,
"Guatémaltèque": null,
"Guinéenne": null,
"Bissao-Guinéenne": null,
"Equato-Guinéenne": null,
"Guyanienne": null,
"Haïtienne": null,
"Hondurienne": null,
"Hongroise": null,
"Indienne": null,
"Indonésienne": null,
"Iranienne": null,
"Iraquienne": null,
"Irlandaise": null,
"Islandaise": null,
"Israélienne": null,
"Italienne": null,
"Jamaïquaine": null,
"Japonaise": null,
"Jordanienne": null,
"Kazakhe": null,
"Kényane": null,
"Kirghize": null,
"Kiribatienne": null,
"Koweïtienne": null,
"Laotienne": null,
"Lesothane": null,
"Lettone": null,
"Libanaise": null,
"Libérienne": null,
"Libyenne": null,
"Liechtensteinoise": null,
"Lituanienne": null,
"Luxembourgeoise": null,
"Malgache": null,
"Malaisienne": null,
"Malawienne": null,
"Maldivienne": null,
"Malienne": null,
"Maltaise": null,
"Marocaine": null,
"Marshallaise": null,
"Mauricienne": null,
"Mauritanienne": null,
"Mexicaine": null,
"Micronésienne": null,
"Moldave": null,
"Monégasque": null,
"Mongole": null,
"Mozambicaine": null,
"Namibienne": null,
"Nauruane": null,
"Népalaise": null,
"Nicaraguayenne": null,
"Nigérienne": null,
"Nigériane": null,
"Norvégienne": null,
"Néo-Zélandaise": null,
"Omanaise": null,
"Ougandaise": null,
"Ouzbèke": null,
"Pakistanaise": null,
"Panaméenne": null,
"Papouane-Néo-Guinéenne": null,
"Paraguayenne": null,
"Néerlandaise": null,
"Péruvienne": null,
"Philippine": null,
"Polonaise": null,
"Portugaise": null,
"Qatarienne": null,
"Roumaine": null,
"Britannique": null,
"Russe": null,
"Rwandaise": null,
"Kittitienne": null,
"Névicienne": null,
"Saint-Lucienne": null,
"Saint-Marinaise": null,
"Saint-Vincentaise et Grenadine": null,
"Salomonaise": null,
"Salvadorienne": null,
"Samoane": null,
"Santoméenne": null,
"Sénégalaise": null,
"Seychelloise": null,
"Sierra-Léonaise": null,
"Singapourienne": null,
"Slovaque": null,
"Slovène": null,
"Somalienne": null,
"Soudanaise": null,
"Sri-Lankaise": null,
"Suédoise": null,
"Suisse": null,
"Surinamaise": null,
"Swazie": null,
"Syrienne": null,
"Tadjike": null,
"Tanzanienne": null,
"Tchadienne": null,
"Tchèque": null,
"Thaïlandaise": null,
"Togolaise": null,
"Tonguienne": null,
"Trinidadienne": null,
"Tunisienne": null,
"Turkmène": null,
"Turque": null,
"Tuvaluane": null,
"Ukrainienne": null,
"Uruguayenne": null,
"Vanuatuane": null,
"Vénézuélienne": null,
"Vietnamienne": null,
"Yéménite": null,
"Yougoslave": null,
"Zaïroise": null,
"Zambienne": null,
"Zimbabwéenne": null
}

var datepickerConfigWithMaxDate = { 
    format: 'dd/mm/yyyy',
    firstDay: 1, 
    showClearBtn: true,
    yearRange: 10,
    maxDate: new Date(),
    i18n: {
      cancel: 'Annuler',
      clear: 'Effacer',
      months: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
      monthsShort: ['Janv', 'Févr', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'],
      weekdays: ['Dimanche','Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
      weekdaysShort: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
      weekdaysAbbrev: ['D','L', 'M', 'M', 'J', 'V', 'S']
    }
}

var setModale = function (values) {
    values.forEach(value => {
        var text =  $('#' + value).text();
        if ( text != "" && text != "Jamais" && text != "Oui" && text != "Non") {
            $('#MAJ' + value).val( $('#' + value).text() );
            $('#MAJ' + value + ' ~ label').addClass( 'active' );
        } else if (text == "Oui" ) {
            $('#MAJ' + value )[0].checked = true;
        } else if (text == "Non") {
            $('#MAJ' + value )[0].checked = false;
        }
    });
}

var updateCard = function (datasToSend, postAddress, fnUpdateFields) {
    // Récupération du token CSRF
    $.get("/csrfToken", function (data, jwres) {
        if (jwres != 'success') { 
            alert('Une erreur est survenue, veuillez réessayer.');
        } else {
            var msg = {
                benef: datasToSend,
                _csrf: data._csrf
            };
            
            // On envoie les données au serveur
            $.post( '/beneficiaires/' + postAddress, msg, function( data ) {
                if(!data.error) {
                    // MàJ ok
                    M.toast({html: 'Mise à jour effectuée !'});
                    /* Mise à jour IHM */
                    fnUpdateFields(data);
                } else {
                    // Message d'erreur sinon
                    alert(data.error);
                }
            });
        }
    });
}

var getValueFromField = function(field) {
    var field = $('#' + field)[0];
    return (!field) ? "" : field.value;
}

var getValueFromCheckBox = function(checkbox) {
    return $('#'+checkbox).prop('checked');
  }

var getID = function() {
    return parseInt($('#numCarte')[0].innerText)
}

$(document).ready(function() {

    // Initialisations
    $('.tabs').tabs();
    $('.collapsible').collapsible();
    $('.modal').modal();
    $('.maxToday.datepicker').datepicker(datepickerConfigWithMaxDate);
    $('input.autocomplete.pays-naissance').autocomplete({ minLength: 2, data: listePays });
    $('input.autocomplete.nationalite').autocomplete({ minLength: 2, data: listeNationalites });

    // Toaster d'incription
    if(sessionStorage.getItem("InscriptionStatus")) {
        M.toast({html: 'Inscription effectuée !'});
        sessionStorage.clear();
    }
        
});

/* ---- MAJ CARTE "Identité" ---- */

// Préparation Modale
$('#goingUpdateIdentite').click(function() {
    valuesToUpdate = ['nom', 'nomJF', 'prenom', 'dateNaissance', 'nationalite', 'paysNaissance'];
    setModale(valuesToUpdate);
});
// Envoi de la MAJ
$('#updateIdentite').click(function() {

    var newIdentite = {
        id: getID(),
        prenom: getValueFromField('MAJprenom'),
        nom: getValueFromField('MAJnom'),
        nomJeuneFille: getValueFromField('MAJnomJF'),
        dateNaissance: getValueFromField('MAJdateNaissance'),
        nationalite: getValueFromField('MAJnationalite'),
        paysNaissance: getValueFromField('MAJpaysNaissance')
    }

    updateCard( newIdentite, 
                'updateIdentite', 
                function(data) {
                    $('#nom').text(data.nom.toUpperCase());
                    $('#nomJF').text(data.nomJeuneFille);
                    $('#prenom').text(data.prenom);
                    $('#dateNaissance').text(data.dateNaissance);
                    $('#nationalite').text(data.nationalite);
                    $('#paysNaissance').text(data.paysNaissance);
                })
});


/* ---- MAJ CARTE "Coordonnées" ---- */

// Préparation Modale
$('#goingUpdateCoordonnees').click(function() {
    valuesToUpdate = ['adresse', 'codePostal', 'ville', 'mail', 'numTel', 'telAvocat', 'telAssistanteSociale', 'telAssociation'];
    setModale(valuesToUpdate);
});
// Envoi de la MAJ
$('#updateCoordonnees').click(function() {

    var newCoordonnees = {
        id: getID(),
        adresse: getValueFromField('MAJadresse'),
        codePostal: getValueFromField('MAJcodePostal'),
        ville: getValueFromField('MAJville'),
        mail: getValueFromField('MAJmail'),
        telephone: getValueFromField('MAJnumTel'),
        numAvocat: getValueFromField('MAJtelAvocat'),
        numAssistSociale: getValueFromField('MAJtelAssistanteSociale'),
        numAsso: getValueFromField('MAJtelAssociation')
    }

    updateCard( newCoordonnees, 
                'updateCoordonnees', 
                function(data) {
                    $('#adresse').text(data.adresse);
                    $('#codePostal').text(data.codePostal);
                    $('#ville').text(data.ville);
                    $('#mail').text(data.mail);
                    $('#numTel').text(data.telephone);
                    $('#telAvocat').text(data.numAvocat);
                    $('#telAssistanteSociale').text(data.numAssistSociale);
                    $('#telAssociation').text(data.numAsso);
                })
});


/* ---- MAJ CARTE "Permis de conduire" ---- */

// Préparation Modale
$('#goingUpdatePermisConduire').click(function() {
    valuesToUpdate = ['datePermis', 'aUneVoiture'];
    setModale(valuesToUpdate);
});
// Envoi de la MAJ
$('#updatePermisConduire').click(function() {

    var newPermisConduire = {
        id: getID(),
        datePermis: getValueFromField('MAJdatePermis'),
        aUneVoiture: getValueFromCheckBox('MAJaUneVoiture')
    }

    updateCard( newPermisConduire, 
                'updatePermisConduire', 
                function(data) {
                    var date = data.datePermis == "" ? "Jamais" : data.datePermis;
                    var aVoiture = data.aUneVoiture ? "Oui" : "Non"
                    $('#datePermis').text(date);
                    $('#aUneVoiture').text(aVoiture);
                })
});